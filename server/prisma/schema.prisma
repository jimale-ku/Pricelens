generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String             @id @default(uuid())
  email            String             @unique
  passwordHash     String?
  firstName        String?
  lastName         String?
  avatarUrl        String?
  googleId         String?            @unique
  googleEmail      String?
  lastLoginAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  refreshTokens    RefreshToken[]
  lists            UserList[]
  favorites        Favorite[]
  savedComparisons SavedComparison[]
  priceAlerts      PriceAlert[]
  preferences      UserPreference?
  subscription     Subscription?
  stripeCustomer   StripeCustomer?
  usage            UserUsage[]

  @@index([email])
}

model RefreshToken {
  id          String    @id @default(uuid())
  token       String    @unique
  userId      String
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())
  createdByIp String?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Week 2: Price Comparison Models

model Category {
  id             String          @id @default(uuid())
  name           String          @unique
  slug           String          @unique
  icon           String?
  description    String?
  shoppingTips   String?
  displayOrder   Int             @default(0)
  enabled        Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  products       Product[]
  advertisements Advertisement[]

  @@index([slug])
  @@index([displayOrder])
}

model Store {
  id            String          @id @default(uuid())
  name          String          @unique
  slug          String          @unique
  logo          String?
  websiteUrl    String?
  apiEndpoint   String?
  apiKey        String?
  enabled       Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  productPrices ProductPrice[]
  locations     StoreLocation[]

  @@index([slug])
  @@index([enabled])
}

model Product {
  id               String             @id @default(uuid())
  name             String
  description      String?
  images           String[]
  barcode          String?            @unique
  brand            String?
  categoryId       String
  subcategory      String?
  externalIds      Json?
  searchCount      Int                @default(0)
  viewCount        Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  category         Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  prices           ProductPrice[]
  priceHistory     PriceHistory[]
  listItems        ListItem[]
  favorites        Favorite[]
  savedComparisons SavedComparison[]
  priceAlerts      PriceAlert[]

  @@index([categoryId])
  @@index([barcode])
  @@index([searchCount])
  @@index([name])
  @@index([subcategory])
}

model ProductPrice {
  id           String   @id @default(uuid())
  productId    String
  storeId      String
  price        Decimal  @db.Decimal(10, 2)
  shippingCost Decimal  @db.Decimal(10, 2) @default(0)
  currency     String   @default("USD")
  inStock      Boolean  @default(true)
  productUrl   String?
  lastUpdated  DateTime @default(now())
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  store        Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([productId, storeId])
  @@index([productId])
  @@index([storeId])
  @@index([price])
}

model PriceHistory {
  id         String   @id @default(uuid())
  productId  String
  storeId    String
  price      Decimal  @db.Decimal(10, 2)
  recordedAt DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, recordedAt])
  @@index([storeId, recordedAt])
}

// Week 3: User Features Models

model UserList {
  id          String     @id @default(uuid())
  userId      String
  name        String
  description String?
  isDefault   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       ListItem[]

  @@index([userId])
}

model ListItem {
  id          String   @id @default(uuid())
  listId      String
  productId   String
  quantity    Int      @default(1)
  notes       String?
  isPurchased Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  list        UserList @relation(fields: [listId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([listId, productId])
  @@index([listId])
  @@index([productId])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model SavedComparison {
  id        String   @id @default(uuid())
  userId    String
  productId String
  notes     String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
}

// Week 4: Analytics & Insights Models

model PriceAlert {
  id          String   @id @default(uuid())
  userId      String
  productId   String
  targetPrice Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  notified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([isActive])
}

// Week 5: Advanced Features Models

model StoreLocation {
  id        String   @id @default(uuid())
  storeId   String
  address   String
  city      String
  state     String
  zipCode   String
  latitude  Float?
  longitude Float?
  phone     String?
  hours     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([zipCode])
  @@index([city, state])
}

model Advertisement {
  id           String   @id @default(uuid())
  categoryId   String?
  title        String
  description  String
  imageUrl     String?
  ctaText      String   @default("Learn More")
  ctaUrl       String
  sponsorName  String
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  impressions  Int      @default(0)
  clicks       Int      @default(0)
  startDate    DateTime @default(now())
  endDate      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  category     Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([categoryId])
  @@index([isActive])
  @@index([displayOrder])
}

model UserPreference {
  id                String   @id @default(uuid())
  userId            String   @unique
  defaultStores     String[] // Array of store IDs
  searchRadius      Int      @default(10) // miles
  preferredZipCode  String?
  priceAlertEmail   Boolean  @default(true)
  trendingEmail     Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Subscription Models

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
}

// FREE = 0, BASIC = 1, PRO = 2, PREMIUM = 3. PLUS is legacy (treat as PRO).
enum SubscriptionTier {
  FREE
  PLUS    // legacy; treat as PRO
  BASIC
  PRO
  PREMIUM
}

model SubscriptionPlan {
  id                  String         @id @default(uuid())
  name                String         @unique // "Free", "Basic", "Pro", "Premium"
  tier                SubscriptionTier @unique
  price               Decimal        @db.Decimal(10, 2) @default(0)
  priceYearly         Decimal?       @db.Decimal(10, 2) // optional yearly price (e.g. 2 months free)
  currency            String         @default("USD")
  interval            String         // "month", "year"
  stripePriceId       String?        @unique // monthly Stripe Price ID
  stripePriceIdYearly String?        @unique // yearly Stripe Price ID
  trialPeriodDays     Int?           // e.g. 30 for 30-day free trial
  features            Json           // Array of feature strings
  maxSearches       Int?           // null = unlimited
  maxStores         Int?           // null = unlimited
  maxFavorites      Int?           // null = unlimited
  maxLists          Int?            // null = unlimited
  maxAlerts         Int?            // null = unlimited
  hasPriceHistory   Boolean        @default(false)
  hasAdvancedFilters Boolean       @default(false)
  hasAdFree         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subscriptions     Subscription[]

  @@index([tier])
}

model Subscription {
  id                  String             @id @default(uuid())
  userId              String             @unique
  planId              String
  status              SubscriptionStatus @default(ACTIVE)
  tier                SubscriptionTier   @default(FREE)
  stripeSubscriptionId String?           @unique
  stripeCustomerId    String?
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean           @default(false)
  canceledAt          DateTime?
  trialEndsAt         DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                SubscriptionPlan   @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([tier])
}

model StripeCustomer {
  id              String   @id @default(uuid())
  userId          String   @unique
  stripeCustomerId String  @unique
  email           String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
}

model UserUsage {
  id            String   @id @default(uuid())
  userId        String
  date          DateTime @default(now())
  searches      Int      @default(0)
  favorites     Int      @default(0)
  lists         Int      @default(0)
  alerts        Int      @default(0)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

// Serper API response cache â€“ avoid repeated Serper calls for same query
model SerperCache {
  id        String   @id @default(uuid())
  cacheKey  String   @unique // e.g. "maps:gym 90210" or hash of params
  type      String   // "maps" | "shopping" | "search"
  response  Json     // raw API response
  expiresAt DateTime
  createdAt DateTime @default(now())  @@index([cacheKey])
  @@index([expiresAt])
}